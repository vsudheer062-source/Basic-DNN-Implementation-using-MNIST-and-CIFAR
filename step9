# Cell 9: CIFAR-10 Example
def run_cifar10_experiment():
    """
    Run complete CIFAR-10 experiment
    """
    
    # Set device
    device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
    print(f"Using device: {device}")
    
    # Configuration
    batch_size = 128
    num_epochs = 20
    learning_rate = 0.001
    
    print(f"\n{'='*60}")
    print(f"DEEP NEURAL NETWORK PROJECT - CIFAR-10 DATASET")
    print(f"{'='*60}")
    
    # Load dataset
    print("\n1. Loading CIFAR-10 Dataset...")
    data_loader = DatasetLoader('cifar10', batch_size=batch_size)
    dataset_info = data_loader.get_dataset_info()
    
    print(f"Dataset: {dataset_info['name']}")
    print(f"Input shape: {dataset_info['input_shape']}")
    print(f"Number of classes: {dataset_info['num_classes']}")
    print(f"Training samples: {len(data_loader.train_dataset)}")
    print(f"Test samples: {len(data_loader.test_dataset)}")
    
    # Visualize samples
    print("\n2. Visualizing Sample Data...")
    data_loader.visualize_samples(16)
    
    # Create CNN model for CIFAR-10
    print("\n3. Creating CNN Model for CIFAR-10...")
    input_channels = 3  # RGB channels
    model = CNNModel(input_channels, dataset_info['num_classes'], input_size=32)
    
    # Display model information
    model_info = model.get_model_info()
    print(f"Model Type: {model_info['model_type']}")
    print(f"Total Parameters: {model_info['total_parameters']:,}")
    print(f"Trainable Parameters: {model_info['trainable_parameters']:,}")
    
    # Initialize trainer
    print("\n4. Initializing Trainer...")
    trainer = ModelTrainer(model, data_loader.train_loader, data_loader.test_loader, device)
    
    # Train model
    print("\n5. Training Model...")
    training_history = trainer.train(
        num_epochs=num_epochs,
        learning_rate=learning_rate,
        optimizer_type='adam',
        scheduler_type='step',
        save_best=True
    )
    
    # Plot training history
    print("\n6. Plotting Training History...")
    evaluator = ModelEvaluator(model, device)
    evaluator.plot_training_history(
        training_history['train_losses'],
        training_history['train_accuracies'],
        training_history['val_losses'],
        training_history['val_accuracies']
    )
    
    # Final evaluation
    print("\n7. Final Model Evaluation...")
    evaluation_results = evaluator.evaluate_model(
        data_loader.test_loader, 
        class_names=dataset_info['classes']
    )
    
    print(f"Final Test Accuracy: {evaluation_results['accuracy']:.2f}%")
    print(f"Final Test Loss: {evaluation_results['loss']:.4f}")
    
    # Display detailed classification report
    print("\nDetailed Classification Report:")
    clf_report = evaluation_results['classification_report']
    
    print(f"{'Class':<15} {'Precision':<10} {'Recall':<10} {'F1-Score':<10} {'Support':<10}")
    print("-" * 60)
    
    for class_name in dataset_info['classes']:
        if class_name in clf_report:
            metrics = clf_report[class_name]
            print(f"{class_name:<15} {metrics['precision']:<10.3f} {metrics['recall']:<10.3f} "
                  f"{metrics['f1-score']:<10.3f} {metrics['support']:<10}")
    
    print("-" * 60)
    print(f"{'Overall':<15} {clf_report['macro avg']['precision']:<10.3f} "
          f"{clf_report['macro avg']['recall']:<10.3f} "
          f"{clf_report['macro avg']['f1-score']:<10.3f} {clf_report['macro avg']['support']:<10}")
    
    # Plot confusion matrix
    print("\n8. Plotting Confusion Matrix...")
    evaluator.plot_confusion_matrix(
        evaluation_results['targets'],
        evaluation_results['predictions'],
        dataset_info['classes'],
        title='CNN - CIFAR-10 Confusion Matrix'
    )
    
    return model, training_history, evaluation_results

# Run CIFAR-10 experiment
cifar10_model, cifar10_history, cifar10_results = run_cifar10_experiment()
